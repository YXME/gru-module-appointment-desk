<link rel="stylesheet" href="css/admin/plugins/appointment/appointment.css">
<link rel="stylesheet" href="js/plugins/appointment/fullcalendar.min.css" >
<link rel="stylesheet" href="css/admin/plugins/appointment/fullcalendar.custom.css" >
<link rel="stylesheet" href="css/admin/plugins/appointment/appointment_desk.css">
<link rel='stylesheet' href="css/plugins/appointment/bootstrap-datetimepicker.css">
<@appointmentTabs tab='day' form=appointmentForm >
	<div id="calendar" class="fc ui-widget fc-ltr">
		<div class="fc-toolbar fc-header-toolbar row">
			<div class="fc-left">
				<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' >
					<#assign dDay = day?date>
					<#assign pDay = dDay?long - (1 * 24 * 60 * 60 * 1000)>
					<@input type='hidden' name='id_form' value='${idForm!1}' />
					<@input type='hidden' name='day' value='${pDay?number_to_date}' />
					<button type="submit" class="btn btn-primary btn-sm">
						#i18n{module.appointment.desk.label.prevDay}
					</button>
				</@tform>
			</div>
			<div class="fc-right">
				<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' class='hidden-xs'>
					<#assign nDay = dDay?long + (1 * 24 * 60 * 60 * 1000)>
					<@input type='hidden' name='id_form' value='${idForm!1}' />
					<@input type='hidden' name='day' value='${nDay?number_to_date}' />
					<button type="submit" class="btn btn-primary btn-sm">
						#i18n{module.appointment.desk.label.nextDay}
					</button>
				</@tform>
			</div>
			<div class="fc-center">
				<#if day?date?string != .now?date?string >
					<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' >
						<#assign dDay = .now>
						<@input type='hidden' name='id_form' value='${idForm!1}' />
						<@input type='hidden' name='day' value='${dDay?date}' />
						<button type="submit" class="btn btn-primary btn-sm">
							#i18n{module.appointment.desk.label.today}
						</button>
					</@tform>
				</#if>
				<@tform type='inline' id='manage_appointmentdesk' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp'>
					<input type="hidden" name="id_form" value="${idForm!1}">
					<button type="button" class="fc-datepicker btn btn-primary btn-sm">
						Choisir une date 
					</button>
					<@input type='text' name='day' id='day' value="${day!''}" params=' style="border:none;font-family: \'Source Sans Pro\',sans-serif;font-size:30px"' />
				</@tform>
			</div>
		</div>
		<div class="fc-clear"></div>
		<div class="fc-view-container">
			<div class="fc-view fc-agendaWeek-view fc-agenda-view">
			<@table id='selectable' class="clearfix" >
			<tr>
				<th>
					<@button type='button' color='link' style='btn-link' class='open-desk' params=' data-toggle="modal"' buttonTargetId='#deskModal' title='#i18n{appointmentdesk.manage_appointmentdesks.label.addDesk}' hideTitle=[''] buttonNested=true >
						<@iconStack class='fa-1x'>
							<@icon style='desktop' class='fa-stack-2x' />
							<@icon style='plus' class='fa-stack-1x' />
						</@iconStack>
					</@button>
				</th>
				<#assign x=numb_desk>
				<#list 1..x as seq >
					<th style="width:${100*x}px;">#i18n{module.appointment.desk.label.desk} #i18n{module.appointment.desk.label.deskNo}${seq}</th>
				</#list>
				<th style="width:${100*x}px;" class="header-surbook bg-danger">#i18n{module.appointment.desk.label.surbooking}</th>
			</tr>
			<tr>
				<td style="width:${100*x}px;">
					<@button id='toggle-add-comment' style='none' class='btn btn-link' title='#i18n{module.appointment.desk.label.addComment}' hideTitle=[''] params=' data-toggle="modal" data-target="#commentModal" ' buttonNested=true>
						<@iconStack class='fa-sm'>
							<@icon prefix='far fa-' style='comment' class='fa-stack-2x' />
							<@icon style='plus' class='fa-stack-1x' />
						</@iconStack>
					</@button>								
				</td>
				<td style="width:${110*x}px;" colspan="${x}">
				<#if list_comments?size gt 0>
					<#list list_comments as comment>
						<#if !comment.startingValidityTime?? && !comment.endingValidityTime??>
							<#assign comment_title>${comment.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}</#assign>
							<span class="fc-event comments">
								<div class="fc-content " id="comment_${comment.id}">
									<span class="fc-title">
										${comment_title}
									</span>
								</div>
							</span>
						</#if>
					</#list>
				</#if>
				</td>
				<td style="width:${110*x}px;" class="bg-danger"></td>
			</tr>
			<@tableHeadBodySeparator />
			<#assign idx=1>
			<#list list_slot?sort_by('startingDateTime') as slot>
				<tr <#if idx=1>class="first"</#if>>
					<td data-selectable="row">${slot.startingTime!}
					<#if list_comments?size gt 0>
						<#list list_comments as comment>
							<#if comment.startingValidityTime?? || comment.endingValidityTime??>
								<#assign startLabel>${comment.startingValidityTime!'${list_slot[0].startingTime!}'}</#assign>
								<#assign endLabel>${comment.endingValidityTime!'${list_slot[list_slot?size - 1].endingTime!}'}</#assign>
								<#assign comment_title>${comment.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}</#assign>
								<#if startLabel?split(':')[0] == slot.startingTime?split(':')[0]>
								<span class="fc-event comments timed-comment" style="height: calc(( ${endLabel?split(':')[0]} - ${startLabel?split(':')[0]} ) * 100%);">
									<div class="fc-content hover-content timed-comment-content" id="comment_${comment.id}" >
									</div>
								</span>
								</#if>
							</#if>
						</#list>
					</#if>
					</td>	
					<#setting datetime_format="iso">
					<#list 1..x as seq >
						<td style="width:${110*x}px;" class="place desk-${seq} slot-${slot.idSlot!} start-${slot.startingDateTime?datetime.iso?string["ddMM-HHmm"]} selectable <#if slot.isOpen && ( seq - slot.maxCapacity lte 0) >slot-open<#else>slot-close</#if>" data-marker=".desk-${seq}.slot-${slot.idSlot!}.start-${slot.startingDateTime?datetime.iso?string["ddMM-HHmm"]}" data-slot="{'idSlot':'${slot.idSlot!}','startingDateTime':'${slot.startingDateTime}','endingDateTime':'${slot.endingDateTime}','maxCapacity':'${slot.maxCapacity}','isOpen':'<#if slot.isOpen && seq lte slot.maxCapacity >true<#else>false</#if>','isSpecific':'${slot.isSpecific?c}','idForm':'${slot.idForm!1}'}" ></td>	
					</#list>
					<td style="width:${110*x}px;"  class="desk-${x+1} start-${slot.startingDateTime?datetime.iso?string["ddMM-HHmm"]} bg-danger is-surbook" data-slot="" >
				</tr>
				<#assign idx=0>
			</#list>
		</@table>
		</div>
	</div>
</@appointmentTabs>

<script src="js/plugins/appointment/moment.min.js"></script>
<script src="js/plugins/appointment/bootstrap-datetimepicker.min.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/locales/bootstrap-datepicker.<@getRegional language=language />.js" charset="utf-8"></script>

<@modal id='qModal'>
	<@modalBody>
		<p id="loader" class="text-center">
			<i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw"></i>
			<span class="sr-only">#i18n{blog.modify_blog.labelLoading}</span>
		</p>
		<iframe style="width:100%;height:60vh;border:0" frameborder="0" id="qModalFrame" src=""></iframe>
	</@modalBody>
</@modal>

<@modal id='slottoggle' size='sm'>
	<@modalBody>
	<div style="margin-left:25%">
		<@radioButton id='doOpenSlot' name='doManageSlot' value='1' labelFor='doOpenSlot' labelKey='#i18n{module.appointment.desk.label.open}' /> 
		<@radioButton id='doCloseSlot' name='doManageSlot'  value='0' labelFor='doCloseSlot' labelKey='#i18n{module.appointment.desk.label.close}' /> 
	</div>
	<div style="text-align: center;">
		<@button id='saveSlotState' color='primary' title='#i18n{module.appointment.desk.label.save}' />
		<@button id='cancelSlotState' color='secondary' title='#i18n{module.appointment.desk.label.cancel}' params=' data-dismiss="modal" aria-label="#i18n{module.appointment.desk.label.cancel}"' />
	</div>
	</@modalBody>
</@modal>

<@modal id='deskModal'>
	<@modalHeader modalTitle='#i18n{module.appointment.desk.increment.defaultTitle}' />
	<@modalBody>
		<p id="loader" class="text-center">#i18n{module.appointment.desk.increment.defaultTitle}</p>
		<@tform id='form-validate' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' params='enctype="multipart/form-data"'>
			<@input type='hidden' name='action' value='incrementMaxCapacity' />
			<@input type='hidden' name='id_form' value='${idForm!}' />
			<@input type='hidden' id='day' name='day' value='${day!}' />
			<@formGroup labelFor='incrementing_value' labelKey='#i18n{module.appointment.desk.increment.labelIncrementingValue}' helpKey='${formGroupHelpKey!}' mandatory=true>
					<@input type='number' name='incrementing_value' id='incrementing_value' value='1' maxlength=2 params='onkeypress="return validateQty(event);"' min=1 max=10 />
			</@formGroup>
			<@formGroup labelFor='type' labelKey='#i18n{module.appointment.desk.increment.labelType}'>
				<@select name='type' id='type' items=list_types default_value='' />
			</@formGroup>
			<@formGroup labelFor='startingDate' labelKey='#i18n{module.appointment.desk.increment.labelStartingDate}'>
				<@inputGroup>
					<@input type='text' name='starting_date' id='startingDate' value="${day!}" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='startingTime' labelKey='#i18n{module.appointment.desk.increment.labelStartingTime}'>
				<@inputGroup>
					<@input type='text' name='starting_time' id='startingTime' value='' />
					<@inputGroupItem type='text'>
						<@icon style='clock-o' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingDate' labelKey='#i18n{module.appointment.desk.increment.labelEndingDate}'>
				<@inputGroup>
					<@input type='text' name='ending_date' id='endingDate' value="${day!}" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingTime' labelKey='#i18n{module.appointment.desk.increment.labelEndingTime}'>
				<@inputGroup>
					<@input type='text' name='ending_time' id='endingTime' value='' />
					<@inputGroupItem type='text'>
						<@icon style='clock-o' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup>
				<@button type='submit' name='save' id='save' buttonIcon='check' title='#i18n{module.appointment.desk.increment.labelValidate}' />
			</@formGroup>	
		</@tform>
	</@modalBody>
</@modal>

<@modal id='commentModal'>
	<@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "startingValidityDate" "endingValidityDate" "idStartingTime" "idEndingTime" "doAddComment" idForm language />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='modify-comment'>
	<@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "modifyStartingValidityDate" "modifyEndingValidityDate" "idModifyStartingTime" "idModifyEndingTime" "doModifyComment" idForm language />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>
<#if activateEditMode>
<script src="js/admin/plugins/appointment/selectable.min.js"></script>
<script src="js/admin/plugins/appointment/selectable.table.min.js"></script>
</#if>
<script src="js/admin/plugins/appointment/appointment_desk.js"></script>
<script>
$(function () {
	<#if activateEditMode>
	/* Add selectable function to table cell */
	setSelection();
	</#if>
	$('.bt-slot > .fa').toggle();
	
	$('#day').datepicker({
		language : '${language}',
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	}).on( 'changeDate', function(e) {
		// `e` here contains the extra attributes
		$('#manage_appointmentdesk').submit();
	});

	$('.fc-datepicker').click( function(){
		$('#day').datepicker('show');
	});

	$('#qModal').on('shown.bs.modal', function () {
		$('#qModalFrame').attr("src", urlPublished );
		$('#qModalFrame').load( function () {
		$('#qModalFrame').show();
		$('#loader').hide();
		});
	});
	
	// DESK ADD MODAL
	$('#startingTime').datetimepicker({
		format: 'HH:mm',
		stepping: 1
	});

	$('#endingTime').datetimepicker({
		format: 'HH:mm',
		stepping: 1
	});

	$('#startingDate').datepicker({
		language : "${language}",
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	}).on( 'changeDate', function(e) {
		// `e` here contains the extra attributes
		$('#deskModal #day').val( $(this).val() );
	});

	$('#endingDate').datepicker({
		language : "${language}",
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	});  
	
	<#if list_comments?size gt 0>
		<#list list_comments as comment>
			<#assign comment_title>${comment.comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '\\"')}</#assign>
			<#if !comment.startingValidityTime?? && !comment.endingValidityTime??>
			$('#comment_${comment.id} p').prepend( '[ ${comment.creatorUserName!} | ${comment.creationDate?date.xs!} ] ').append( '<div class="btn-comments"><a href="" class="toggle-modify-comment" data-json=\'{\"id_comment\": \"${comment.id}\", \"comment_text\": \"${comment_title}\", \"comment_start\":\"${comment.startingValidityDate!}\", \"comment_start_time\":\"${comment.startingValidityTime!}", \"comment_end\":\"${comment.endingValidityDate!}", \"comment_end_time\":\"${comment.endingValidityTime!}" }\' ><i class="fa fa-pencil fa-fw"></i></a><a href="jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=${comment.id}" class="closeon text-danger"><i class="fa fa-remove fa-fw"></i></a></div>');
			var json = {
				"container": "body",
				"placement" : "bottom",
				"html" : true,
				"trigger" : "hover"
			};
			<#else>
	        $('#comment_${comment.id}').append( '<div class="btn-comments"><span data-json=\'{\"id_comment\": \"${comment.id}\", \"comment_text\": \"${comment_title}\", \"comment_start\":\"${comment.startingValidityDate!}\", \"comment_start_time\":\"${comment.startingValidityTime!}", \"comment_end\":\"${comment.endingValidityDate!}", \"comment_end_time\":\"${comment.endingValidityTime!}", \"comment_creator\":\"${comment.creatorUserName!}", \"comment_creation_date\":\"${comment.creationDate!}" }\' ><i class="fa fa-pencil fa-fw"></i></span></div>');
	        var json = {
	                "container": "body",
	                "placement" : "right",
	                "html" : true,
	                "trigger" : "click"
	            };
	        </#if>
			if ( '${comment.endingValidityDate}' == null || '${comment.endingValidityDate}' == undefined ){
				labelEventDate='Le ' + '${comment.startingValidityDate?date.xs}';
			} else {
				moment.locale("${locale}");
				labelEventDate = 'Du ' + '${comment.startingValidityDate?date.xs} ${comment.startingValidityTime!}'+ ' au '+ '${comment.endingValidityDate?date.xs} ${comment.endingValidityTime!}';
			}
			
			<#if !comment.startingValidityTime?? && !comment.endingValidityTime??>
			json.content = '<p>' + labelEventDate +'</p><hr>${comment_title}<hr><p><strong>Par ${comment.creatorUserName!}</strong> le <time>${comment.creationDate!}</time></p>';
			$('#comment_${comment.id} p').popover( json );
			<#else>
			$("#comment_${comment.id}").click( function ( event ) {
				json.content = '<p>' + labelEventDate +'</p><hr>${comment_title}<hr><p><strong>Par ${comment.creatorUserName!}</strong> le <time>${comment.creationDate!}</time></p><a class="toggle-modify-comment" data-json=\'{\"id_comment\": \"${comment.id}\", \"comment_text\": \"${comment_title}\", \"comment_start\":\"${comment.startingValidityDate!}\", \"comment_start_time\":\"${comment.startingValidityTime!}", \"comment_end\":\"${comment.endingValidityDate!}", \"comment_end_time\":\"${comment.endingValidityTime!}", \"comment_creator\":\"${comment.creatorUserName!}", \"comment_creation_date\":\"${comment.creationDate!}" }\' ><i class="fa fa-pencil fa-fw"></i></a><a href="jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=${comment.id}" class="closeon text-danger"><i class="fa fa-remove fa-fw"></i></a>';
			   $("div[id*=comment_]").not($("#comment_${comment.id}")).each(function(index, element){
				   if( isOver( $(this), event ) ) {
					    json.content += "<p>Du " + new Date(jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_start).toLocaleDateString("${language}") + " " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_start_time + " au " + new Date(jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_end).toLocaleDateString("${language}") + " " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_end_time + "</p>";
					    json.content += "<hr>" + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_text;
					    json.content += "<hr><p><strong>Par " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_creator + "</strong> le " + jQuery.parseJSON( $(this).children().children().attr("data-json") ).comment_creation_date + "</p>";
				   }
			    });
			   $("#comment_${comment.id}").attr("data-content", json.content);
 			   $("#comment_${comment.id}").popover( json );
			});
			</#if>
		</#list>
	</#if>

	var modComment = $('table').find('.toggle-modify-comment');

	$(modComment).click( function(ev) {
		ev.preventDefault();
		var formValues = JSON.parse( $(this).attr( "data-json" ) );
		$("#modify-comment input[name='id_comment']").val( formValues.id_comment );
		tinyMCE.activeEditor.setContent( formValues.comment_text );
		$( "#modify-comment input[name='startingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_start ) );
		$( "#modify-comment input[name='endingValidityDate']" ).datepicker().datepicker( 'setDate', new Date( formValues.comment_end ) );
        $( "#modify-comment input[name='startingValidityTime']" ).val( formValues.comment_start_time );
        $( "#modify-comment input[name='endingValidityTime']" ).val( formValues.comment_end_time );
		$( "#modify-comment" ).modal('show');
	});
	
	var slotsChanged = sessionStorage.getItem('changedSlots'), slotStatus='', itemSelect='';
	var aSlotsChanged = slotsChanged != null ? slotsChanged.split(',') : [];
	if ( aSlotsChanged.length > 0 ){
		aSlotsChanged.forEach( function( item, index, array) {
			if ( index > 0 ){
				if ( $(item).hasClass( slotClass )){
					if( $(item).hasClass( '.isMulti' ) ){
						slotClass += '-multi'
					}
					$(item).addClass( 'border-change-' + slotClass );
				} else {
					itemselect=$(item).parents('tr').children( 'td.'+slotClass );
					itemselect.addClass('border-change-' + slotClass );
				}
			} else {
				slotClass = item;
			}
		});
	}
	
	sessionStorage.clear();
	
	$('.is-multi.is-surbook > span').hover(
		function() {
			var multi = '.is-multi.is-surbook.' + $( this ).attr('class' );
			$( multi ).addClass( 'bg-multi' ).children('span').addClass('hidden').first().removeClass('hidden');
		}, function() {
			var multi = '.is-multi.is-surbook.' + $( this ).attr('class' );
			$( multi ).removeClass( 'bg-multi' ).children('span').removeClass('hidden');
		}
	);
});  

/* Get appointment list to set in day view */
const appointments = [<#list list_appointment?sort_by('appointmentTakenSqlDate')?reverse?sort_by('nbPlaces')?reverse as app>
<#compress>
{"id":"${app.idAppointment}","lastName" : "${app.user.lastName}","firstName" : "${app.user.firstName}","places": ${app.nbPlaces},"slots":[<#list app.slot?sort_by('startingDateTime') as slot>{"id" : "${slot.idSlot}", "start" : "${slot.startingDateTime!?datetime.iso?string["ddMM-HHmm"]}", },</#list>],},
</#compress>
</#list>];

/* Begin set RDV 		*/
const nDesks=${numb_desk+1}, isMultiSlot=${appointmentForm.isMultislotAppointment?c}, appUrlDetail='jsp/admin/plugins/appointment/ManageAppointments.jsp?view=viewAppointment&id_form=${idForm!}&id_appointment=';

/* Add RDV in day view  */
setDayView( appointments );

/* Comments */
function isOver( element, e ) {
	let elementCalculated = element;
    var left = elementCalculated.offset().left,
        top = elementCalculated.offset().top,
        right = left + element.width(),
        bottom = top + element.height();
	if ( e.pageX > left && e.pageX < right && e.pageY > top && e.pageY < bottom ){
		return true;
	} else {
		return false;
	}
}

</script>
<#include "/admin/util/editor/editor.html" />
<@initEditor type='comment' />
