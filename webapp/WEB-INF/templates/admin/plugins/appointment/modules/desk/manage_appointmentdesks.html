<#-- TODO Add id_form value to model -->

<#include "manageappointmentdesk_tabs.html" />
<link rel="stylesheet" href="css/admin/plugins/appointment/appointment_desk.css"/>
<link rel="stylesheet" href="css/plugins/appointment/bootstrap-datetimepicker.css"/>
<script src="js/plugins/appointment/jquery.min.js"></script>
<script src="js/plugins/appointment/moment.min.js" ></script>
<script src="js/plugins/appointment/fullcalendar.min.js"></script>
<script src="js/plugins/appointment/locale-all.js"></script>
<script src="js/plugins/appointment/bootstrap-datepicker.js" ></script>
<script src="js/locales/bootstrap-datepicker.fr.js" ></script>

<script src="js/plugins/appointment/bootstrap-datetimepicker.min.js"></script>

<script src="js/plugins/appointment/selectable.js"></script>
<script src="js/plugins/appointment/selectable.table.min.js"></script>

<@row>
    <@columns>
		<@messages infos=infos errors=errors />
		<!#-- FIXME USE MACRO  @ appointmentTabs tab="specificDay" appointmentform=appointmentform  -->
		<@tabs>
			<@tabList>
				<@tabLink href='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageTypicalWeek&id_form=${idForm!}' title='#i18n{appointment.typicalWeek.pageTitle}' />
				<@tabLink href='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageSpecificWeek&id_form=${idForm!}' title='#i18n{appointment.specificWeek.pageTitle}' />
				<@tabLink active=true href='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp?plugin_name=appointment-desk&id_form=${idForm!}' title='#i18n{appointment.specificDay.pageTitle}' />
			</@tabList>
			<@tabContent>
				<h3>#i18n{appointment-desk.manage_appointmentdesk.title}</h3>
						<@button type='button' class='open-AddBookDialog' params='data-toggle="modal"' buttonTargetId='#my_modal' title='Add this item' buttonIcon='plus-circle' />
      
					<@messages infos=infos />
					<@row>
						<@columns sm=4>
							<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' class="pull-left">
								<#assign dDay = day?date>
								<#assign pDay = dDay?long - (1 * 24 * 60 * 60 * 1000)>
								<@input type='hidden' name='id_form' value='${idForm!1}' />
								<@input type='hidden' name='day' value='${pDay?number_to_date}' />
								<@formGroup labelFor='day' rows=2>
									<@button type='submit' color='primary' name='view_manageAppointmentDesks' buttonIcon='angle-double-left' title="${pDay?number_to_date}" />
								</@formGroup>
							</@tform>
						</@columns>
						<@columns sm=4 class='text-center'>
							<@tform id='manage_appointmentdesk' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp'>
								<@input type='hidden' name='id_form' value='${idForm!1}' />
								<@formGroup labelFor='dayi'>
									<@inputGroup>
										<@inputGroupItem type='text'>
											<@icon style='calendar' />
										</@inputGroupItem>
										<@input type='text' name='day' id='day' value="${day!''}"  />
									</@inputGroup>
								</@formGroup>
							</@tform>
						</@columns>
						<@columns sm=4 class='text-right'>
							<@tform type='inline' name='manage_appointmentdesk' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' class='hidden-xs'>
								<#assign nDay = dDay?long + (1 * 24 * 60 * 60 * 1000)>
								<@input type='hidden' name='id_form' value='${idForm!1}' />
								<@input type='hidden' name='day' value='${nDay?number_to_date}' />
								<@formGroup labelFor='day' rows=2>
									<@button type='submit' color='primary' name='view_manageAppointmentDesks' buttonIcon='angle-double-right' iconPosition='right' title="${nDay?number_to_date}" />
								</@formGroup>
							</@tform>
						</@columns>
					</@row>
					<@table id='selectable' class="clearfix">
						<tr>
							<th></th>
							<#assign x=numb_desk>
							<#list 1..x as seq >
								<th data-selectable="column">Guichet: ${seq}</th>
							</#list>
							<th data-selectable="column" class="bg-danger">Surbooking</th>
						</tr>
						<@tableHeadBodySeparator />
						<tr>
							<td style="width:2%;vertical-align:middle" >
								<@button type='button' title='#i18n{appointment.create_comment.pageTitle}' id='toggle-add-comment' params='data-toggle="modal"' buttonTargetId='#commentModal' buttonIcon='comment-o' hideTitle=['all'] />
							</td>
							<td colspan="${x}">
								<#if list_comments?size gt 0>
									<#list list_comments as comment>
									<div class="comments" data-pop="{'id':'${comment.id}','comment':'${comment.comment!comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '&quote;')}','start':'${comment.startingValidityDate!}','end':'${comment.endingValidityDate}', 'creator':'${comment.creatorUserName!}','creationDate':'${comment.creationDate?date.xs!''}'}" >
										${comment.comment!comment?replace('\n', '')?replace('\r', '')?replace('\rn', '')?replace('\'', '&apos;')?replace('\"', '&quote;')}
										
									</div>
									</#list>
								</#if>
							</td>
							<td></td>
						</tr>
						<#list list_slot as slot>
							<tr>
								<td style="width:2%" data-selectable="row">${slot.startingTime!}</td>	
								<#list 1..x as seq >
									<!-- <td id="slot-${slot.idSlot!}-desk${x-seq+1!}" class="place selectable <#if slot.isOpen && seq lte slot.maxCapacity >slot-open<#else>slot-close</#if>" data-slot="{'idslot':'${slot.idSlot!}','startingDateTime':'${slot.startingDateTime}','endingDateTime':'${slot.endingDateTime}','maxCapacity':'${slot.maxCapacity}','isOpen':'<#if slot.isOpen && seq lte slot.maxCapacity >true<#else>false</#if>','isSpecific':'${slot.isSpecific?c}','idForm':${slot.idForm!1},'desk':'${seq}'}" > -->
									<td id="slot-${slot.startingTime!?replace(':', '')}-desk${seq}" class="place selectable <#if slot.isOpen && seq lte slot.maxCapacity >slot-open<#else>slot-close</#if>" data-slot="{'idSlot':'${slot.idSlot!}','startingDateTime':'${slot.startingDateTime}','endingDateTime':'${slot.endingDateTime}','maxCapacity':'${slot.maxCapacity}','isOpen':'<#if slot.isOpen && seq lte slot.maxCapacity >true<#else>false</#if>','isSpecific':'${slot.isSpecific?c}','idForm':'${slot.idForm!1}'}" >
									</td>	
								</#list>
								<td id="slot-${slot.idSlot!}-desk${x+1!}" class="bg-danger" data-slot="" >
							</tr>
						</#list>
					</@table>
			</@tabContent>
		</@tabs>
		<hr>
    </@columns>
</@row>

<@modal id='commentModal'>
	<@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "startingValidityDate" "endingValidityDate" "doAddComment" idForm locale />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='modify-comment'>
	<@modalHeader modalTitle='#i18n{appointment.create_comment.pageTitle}' />
	<@modalBody>
		<@getCommentForm "comment" "modifyStartingValidityDate" "modifyEndingValidityDate" "doModifyComment" idForm locale />
	</@modalBody>
	<@modalFooter>
		<@button type='button' params='data-dismiss="modal"' title='#i18n{portal.util.labelCancel}' buttonIcon='times' color='default' />
	</@modalFooter>
</@modal>

<@modal id='qModal'>
	<@modalHeader modalTitle='#i18n{blog.create_blog.labelPreview}' />
	<@modalBody>
		<p id="loader" class="text-center">
			<i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw"></i>
			<span class="sr-only">#i18n{blog.modify_blog.labelLoading}</span>
		</p>
		<iframe style="width:100%;height:60vh;border:0" frameborder="0" id="qModalFrame" src=""></iframe>
	</@modalBody>
</@modal>

<@modal id='slottoggle'>
	<@modalBody>
		<@radioButton id='doOpenSlot' name='doManageSlot' value='1' labelKey='Ouvrir' /> 
		<@radioButton id='doCloseSlot' name='doManageSlot'  value='0' labelKey='Fermer' /> 
		<@button id='saveSlotState' color='primary' title='Enregistrer' />
		<@button id='cancelSlotState' color='secondary' title='Annuler' params=' data-dismiss="modal" aria-label="Close"' />
	</@modalBody>
</@modal>

<@modal id='my_modal'>
	<@modalHeader modalTitle='#i18n{module.appointment.desk.increment.defaultTitle}' />
	<@modalBody>
		<p id="loader" class="text-center">#i18n{module.appointment.desk.increment.defaultTitle}</p>
		<@tform id='form-validate' action='jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp' params='enctype="multipart/form-data"'>
			<@input type='hidden' name='action' value='incrementMaxCapacity' />
			<@input type='hidden' name='id_form' value='${idForm!}' />
			<@formGroup labelFor='incrementing_value' labelKey='#i18n{module.appointment.desk.increment.labelIncrementingValue}' helpKey='${formGroupHelpKey!}' mandatory=true>
					<@input type='number' name='incrementing_value' id='incrementing_value' value='1' maxlength=2 params='onkeypress="return validateQty(event);"' min=1 max=10 />
			</@formGroup>
			<@formGroup labelFor='type' labelKey='#i18n{module.appointment.desk.increment.labelType}'>
				<@select name='type' id='type' items=list_types default_value='' />
			</@formGroup>
			<@formGroup labelFor='startingDate' labelKey='#i18n{module.appointment.desk.increment.labelStartingDate}'>
				<@inputGroup>
					<@input type='text' name='starting_date' id='startingDate' value="${day!}" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='startingTime' labelKey='#i18n{module.appointment.desk.increment.labelStartingTime}'>
				<@inputGroup>
					<@input type='text' name='starting_time' id='startingTime' value='' />
					<@inputGroupItem type='text'>
						<@icon style='clock-o' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingDate' labelKey='#i18n{module.appointment.desk.increment.labelEndingDate}'>
				<@inputGroup>
					<@input type='text' name='ending_date' id='endingDate' value="${day!}" />
					<@inputGroupItem type='text'>
						<@icon style='calendar' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup labelFor='endingTime' labelKey='#i18n{module.appointment.desk.increment.labelEndingTime}'>
				<@inputGroup>
					<@input type='text' name='ending_time' id='endingTime' value='' />
					<@inputGroupItem type='text'>
						<@icon style='clock-o' />
					</@inputGroupItem>
				</@inputGroup>
			</@formGroup>
			<@formGroup>
				<@button type='submit' name='save' id='save' buttonIcon='check' title='#i18n{module.appointment.desk.increment.labelValidate}' />
			</@formGroup>	
		</@tform>
	</@modalBody>
</@modal>

<script>
if( $('.selectable').length > 0 ){
	const table = document.querySelector("table");
	const selectable = new Selectable({
		appendTo: table,
		filter: table.querySelectorAll(".selectable"),
		toggle: true,
		saveState: 10,
		lasso: {
				border: "4px dotted rgba( 0, 248, 41, 1)",
				borderRadius: "0",
				backgroundColor: "rgba(0, 248, 41, 0.5)"
		}       
	});
	selectable.table();
        
	selectable.on("end", function(e, selected, unselected) {
		var slotData='', idx=1;
		const a=selectable.getSelectedNodes();
		const slotSize = a.length;
		if ( slotSize > 0 ){
			a.forEach( function( el ){
				slotData = slotData + el.dataset.slot;
				if( idx < slotSize ) slotData = slotData + ','
				idx++; 
			});

			slotData = '[' +  slotData.replace(/\'/ig,'"') + ']';
			// console.log( slotSize +  '|' + slotData );
			// Show Modal
			$('#slottoggle').modal('show');
			$('#slottoggle').on('shown.bs.modal', function (event) {
				var modal = $(this), btnModal = modal.find('#saveSlotState'), action='', jspUrl = 'jsp/admin/plugins/appointment/modules/desk/ManageAppointmentDesks.jsp?action=', filteredSlotData=null; 
				btnModal.click( function( e ){
					var isOpen = modal.find('.modal-body input:checked').val();
					var JData = JSON.parse( slotData );
					console.log( 'isOpen : ' + isOpen );
					/* Ajax 		*/	
					if( isOpen==0 ){
						action = 'closeAppointmentDesk';
						filteredSlotData = JData.filter( function (slot) {
							return slot.isOpen === 'true';
						});
					} else {
						action = 'openAppointmentDesk';
						filteredSlotData = JData.filter( function (slot) {
							return slot.isOpen === 'false';
						});
					}
					
					var newData =  JSON.stringify( filteredSlotData );
					console.log( 'filteredSlotData.length : ' + filteredSlotData.length );
					if( filteredSlotData.length > 0 ){
						$.ajax({
							url: jspUrl + action,
							dataType: 'json',
							type: 'POST',
							cache: false,
							data:{'data': newData},
							success: function( data, textStatus, jQxhr ){
								console.log( textStatus + ' :' + JSON.stringify( data ) );
								$('#manage_appointmentdesk').submit();
							},
							error: function( jqXhr, textStatus, errorThrown ){
								console.log( textStatus + ' : ' + errorThrown );
								$('#manage_appointmentdesk').submit();
							},
							xhrFields: {
								withCredentials: true
							},
							crossDomain: true
						});
					} else {
						$('#slottoggle').modal('hide');
					}
				});
			});
			$('#slottoggle').on('hidden.bs.modal', function (event) {
				selectable.clear()
			});
		}
	});
}
	
$(function () {
	$('.content-header h1').html('<a href="jsp/admin/plugins/appointment/ManageAppointmentForms.jsp" title="#i18n{appointment.adminFeature.ManageAppointmentForm.name}">#i18n{appointment.adminFeature.ManageAppointmentForm.name}</a>');
	
	$('.bt-slot > .fa').toggle();
	
	$('#day').datepicker({
		language : '${language}',
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	}).on( 'changeDate', function(e) {
		// `e` here contains the extra attributes
		$('#manage_appointmentdesk').submit();
	});
	
	$('#qModal').on('shown.bs.modal', function () {
		$('#qModalFrame').attr("src", urlPublished );
		$('#qModalFrame').load( function () {
		$('#qModalFrame').show();
		$('#loader').hide();
		});
	});

	$('#qModal').on('hide.bs.modal', function () {
		window.location.replace( window.location.href + '?id_form=1&day=${day!}' );
	});
	   
	$(".btn-iframe").click( function(e){
		e.preventDefault();
		urlPublished= $(this).attr("href");
		$('#qModal').modal({ show: true })
	});
	
	$('#startingTime').datetimepicker({
		format: 'HH:mm',
		stepping: 1
	});
	$('#endingTime').datetimepicker({
		format: 'HH:mm',
		stepping: 1
	});

	$('#startingDate').datepicker({
		language : "${language}",
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	});

	$('#endingDate').datepicker({
		language : "${language}",
		weekStart : 1,
		todayBtn : true,
		todayHighLight : true,
		autoclose : true
	});  

	$('.comments').each( function(){
		var pop = {
			"container": "body",
			"placement" : "bottom",
			"html" : true,
			"trigger" : "hover"
		};
		const comment_datas =  $(this).data('pop').replace( /\'/g, '"').replace( /\n/g, '').replace( /\r/g, '');
		const comment = JSON.parse( comment_datas );
		pop.content = '<p> Du '+ comment.start + ' au ' + comment.end + comment.comment +  '<hr><p><strong>Par ' + comment.creator + '</strong> le <time>' + comment.creationDate + '</time>' ;
		$(this).popover( pop );
		$(this).children('p:first').prepend( '[ ' + comment.creator  + ' | ' + comment.creationDate + ' ]' );
		$(this).children('p:first').append( '<div class="btn-comments"><a href="#" class="toggle-modify-comment" data-idcomment="'+comment.id+'" data-text="'+encodeURI( comment.comment )+'" data-start="'+comment.start+'" data-end="'+comment.end+'"]"><i class="fa fa-pencil fa-fw"></i></a><a href="jsp/admin/plugins/appointment/Comments.jsp?action=confirmRemoveComment&id_comment=' + comment.id + '" class="closeon text-danger"><i class="fa fa-remove fa-fw"></i></a></div>');
	}); 

	var modComment = $('table').find('.toggle-modify-comment');

	$(modComment).click(function(ev) {
		ev.preventDefault();
		$("#modify-comment input[name='id_comment']").val( $(this).data('idcomment') );
		tinyMCE.activeEditor.setContent( decodeURI( $(this).data('text') ) );
		$( "#modify-comment input[name='startingValidityDate']" ).datepicker().datepicker( 'setDate',  new Date(  $(this).data('start') ) );
		$( "#modify-comment input[name='endingValidityDate']" ).datepicker().datepicker( 'setDate', new Date(  $(this).data('end') ) );
		$( "#modify-comment" ).modal('show');
	
	});
});  

<#if list_appointment?? && list_appointment?size gt 0>
	<#assign lastApp=list_appointment?last >
	var strRdv='[<#list list_appointment?sort_by('nbPlaces') as app><#list app.slot?sort_by('startingDateTime') as slotApp>{"rdv":${app.idAppointment},"nbPerson":${app.nbPlaces},"slot":${slotApp.idSlot},"dtSlotBegin":${slotApp.startingDateTime},"dtSlotEnd":${slotApp.endingDateTime}}<#if lastApp.idAppointment!=app.idAppointment>,</#if></#list></#list>]';
</#if>

var strSlots='<#list list_appointment as app><#list app.slot as slotApp>${slotApp.idSlot},</#list></#list>';
strSlots = strSlots.slice(0, -1);
var aSlots = strSlots.split(',');

const countOccurrences = (aSlots) => {
    const map = {};
    for ( var i = 0; i < aSlots.length; i++ ) {
        map[aSlots[i]] = ~~map[aSlots[i]] + 1;
    }
    return map;
}

var nSurbook=0;
const mapSlots = countOccurrences(aSlots);
<#assign currRdv=0>
<#list list_appointment?sort_by('nbPlaces') as app>
	<#list app.slot?sort_by('startingDateTime') as slotApp>
		<!-- maxCapacity : ${slotApp.maxCapacity!} -->
		<#if currRdv!=app.idAppointment>

			var pos = mapSlots['${slotApp.idSlot}'];
			
			if( pos > ${numb_desk} ){ 
				nSurbook=pos;
				pos=1 ; 
			}
		</#if>
		if( pos == 0 ){ pos=nSurbook }	
		
		console.log( '${app.user.lastName} ${app.user.firstName} - Slot ${slotApp.idSlot} [ ${slotApp.startingDateTime} - ${slotApp.endingDateTime} ] pos : ' + pos + ' | rdv : ${app.idAppointment}' );
		
		var slotIdFilter='[id^=slot-${slotApp.idSlot}-desk' + pos + ']';
		var slotId='[id^=slot-${slotApp.idSlot}-desk' + pos + ']';
		console.log( 'idFilter : ' + slotIdFilter );
		$( slotIdFilter ).attr('data-rdv','rdv${app.idAppointment}_slot${slotApp.idSlot!}');
		$( slotId ).html('<span>${slotApp.isOpen?c!} / ${slotApp.nbRemainingPlaces!} / ${slotApp.maxCapacity!} / ${app.user.lastName} ${app.user.firstName} <#if app.nbPlaces gt 1>( nb pers. ${app.nbPlaces} )</#if> </span>');
		
		mapSlots['${slotApp.idSlot}'] = pos - 1;
		<#assign currRdv=app.idAppointment>	
	</#list>
</#list>

<#list list_appointment as app>
	<#if app.slot?size gt 1>
		<#list app.slot as appSlot>
			<#if appSlot = app.slot?first>
				var hSize = 45 * ${app.slot?size} + 'px';
				$('[data-rdv="rdv${app.idAppointment}_slot${appSlot.idSlot!}"] > span').css('height', hSize );
			<#else>
				$('[data-rdv="rdv${app.idAppointment}_slot${appSlot.idSlot!}"] > span').css('color','#6d015b');
			</#if>
		</#list>
	</#if>
</#list>
	
</script>
<#include "/admin/util/editor/editor.html" />
<@initEditor />